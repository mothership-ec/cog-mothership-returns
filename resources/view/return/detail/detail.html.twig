{% extends '::return:template' %}

{% block returns %}
	<hgroup class="title">
		<h1>Return {{ return.getDisplayID() }} <span>Last updated: {{ return.authorship.updatedAt|date }}</span></h1>
	</hgroup>
	<div class="container-content tall">
		<section class="dual-column">
			<h2 class="title">
				{{ return.item.description }}
			</h2>
			<div class="content">
				<div class="column">
					{# Show the received form if not yet set #}
					{% if not return.isReceived %}
						<h2>Returned Package</h2>
						{{ form_start(received_form) }}
							{{ form_row(received_form.received) }}
							{{ form_row(received_form.received_date) }}
							{{ form_row(received_form.message) }}

							<button class="button save small">Notify Customer</button>
						{{ form_end(received_form) }}
					{% else %}
						<h2>Returned Package</h2>
						<dl class="order-details">
							<dt>Received</dt>
								<dd>The customer has been notified that the package was received</dd>
						</dl>

						{# Show the accept / reject option if neither action has yet been taken #}
						{% if not return.isAccepted and not return.isRejected %}
							<h2>Accept / Reject</h2>
							{{ form_start(accepted_form) }}
								{{ form_row(accepted_form.accept_reject) }}

								<button class="button save small">Update</button>
							{{ form_end(accepted_form) }}
						{% endif %}
					{% endif %}

					{# Show refund / exchange forms if the return has been accepted #}
					{% if return.isAccepted %}

						{# Show the balance form if not yet enacted #}
						{% if not return.hasBalance %}
							<h2>Outstanding Balance</h2>
							{{ form_start(balance_form) }}
								{{ form_row(balance_form.payee) }}
								{{ form_row(balance_form.balance_amount) }}
								{{ form_row(balance_form.refund_approve) }}
								{{ form_row(balance_form.refund_method) }}
								{{ form_row(balance_form.message) }}

								<button class="button save small">Process Balance</button>
							{{ form_end(balance_form) }}

						{# else show the refund payments made #}
						{% else %}
							<h2>Balance Payment</h2>
							{% for refund in return.refunds %}
								<dl class="order-details">

										{% if return.balance > 0 %}
											<dt>Payee</dt>
												<dd>The customer paid</dd>
										{% else %}
											<dt>Payee</dt>
												<dd>You refunded the customer</dd>
										{% endif %}
									<dt>Amount </dt>
										<dd>{{ refund.amount|price }}</dd>
									<dt>Method</dt>
										<dd>{{ refund.method.getDisplayName() }}</dd>
									<dt>Date</dt>
										<dd>{{ refund.authorship.createdAt()|date }}</dd>
								</dl>
							{% else %}
								<dl class="order-details">
									{% if not return.hasRemainingBalance %}
										<dt>Status</dt>
											<dd>No outstanding balance or payments</dd>
									{% elseif return.payeeIsClient %}
										<dt>Status</dt>
											<dd>Awaiting customer's payment of {{ return.balance|abs|price }}</dd>
									{% endif %}
								</dl>
							{% endfor %}
						{% endif %}

						{# Show the exchange resolution options #}
						{% if return.isExchangeResolution %}
							<h2>Exchange</h2>

							<dl class="order-details">
								<dt>Replacement Item</dt>
									<dd><a href="{{ url('ms.commerce.product.edit.details', {productID: return.exchangeItem.productID}) }}" data-live>{{ return.exchangeItem.productName }} - {{ return.exchangeItem.options }}</a></dd>
							</dl>

							{# Show the exchanged form if not yet enacted #}
							{% if not return.isExchanged %}
								{{ form_start(exchange_form) }}
									<button class="button save small">Set Replacement Ready For Dispatch</button>
								{{ form_end(exchange_form) }}

							{# else notify that the exchange has been made #}
							{% else %}
								<dl class="order-details">
									<dt>Status</dt>
										<dd>{{ return.exchangeItem.status }}</dd>
								</dl>
							{% endif %}
						{% endif %}

						{# Show the returned item form #}
						<h2>Returned Item</h2>

						{% if not return.returnedItemProcessed %}
							{% if not return.hasRemainingBalance() and (return.isRefundResolution() or return.isExchanged()) %}
								{{ form_start(returned_item_form) }}
									{{ form_row(returned_item_form.stock_location) }}

									<button class="button save small">Process Returned Item</button>
								{{ form_end(returned_item_form) }}
							{% else %}
								<dl class="order-details">
									<dt>Status</dt>
										<dd>You must clear the balance and process any exchange
											replacement item before completing the return.</dd>
								</dl>
							{% endif %}
						{% else %}
							<dl class="order-details">
								<dt>Status</dt>
									<dd>{{ return.item.status }}</dd>
							</dl>
						{% endif %}


					{# Show a message if the return has been rejected #}
					{% elseif return.isRejected %}
						<dl class="order-details">
							<dt>Status </dt>
								<dd>This return was <strong>rejected</strong></dd>
						</dl>
					{% endif %}
				</div>
				<div class="column">
					<h2>Return Details</h2>
					<dl class="order-details">
						<dt>Order</dt>
							<dd><a href="{{ url('ms.commerce.order.view.return', {orderID: return.order.id}) }}">{{ return.order.id }}</a></dd>
						<dt>Reason </dt>
							<dd>{{ return.reason }}</dd>
						<dt>Resolution </dt>
							<dd>{{ return.resolution }}
							{% if return.isExchangeResolution %}
								{% if return.exchangeItem %}
									for <a href="{{ url('ms.commerce.product.edit.details', {productID: return.exchangeItem.productID}) }}" data-live>{{ return.exchangeItem.productName }} - {{ return.exchangeItem.options }}</a>
								{% else %}
									{ERROR}
								{% endif %}
							{% endif %}
							</dd>
							{% if not return.hasBalance %}
								{% if return.payeeIsClient %}
									<dt>Customer Balance</dt>
										<dd>{{ return.calculatedBalance|abs|price }}</dd>
								{% elseif return.payeeIsCustomer %}
									<dt>Your Balance</dt>
										<dd>{{ return.calculatedBalance|abs|price }}</dd>
								{% else %}
									<dt>Balance</dt>
										<dd>None</dd>
								{% endif %}
							{% else %}
								{% if return.payeeIsClient %}
									<dt>Customer Balance</dt>
										<dd>{{ return.balance|abs|price }}</dd>
								{% elseif return.payeeIsCustomer %}
									<dt>Your Balance</dt>
										<dd>{{ return.balance|abs|price }}</dd>
								{% else %}
									<dt>Balance</dt>
										<dd>Cleared</dd>
								{% endif %}
							{% endif %}
						<dt>Status </dt>
							<dd>{{ return.item.status }}</dd>
						{% if return.note %}
							<dt>Note</dt>
								<dd>{{ return.note.note }}</dd>
						{% endif %}
						<dt>Created by</dt>
						<dd>{{ return.order.user.name }} on {{ return.authorship.createdAt|date }}</dd>
						{% if not return.authorship.updatedAt is empty and not return.authorship.updatedBy is empty %}
							<dt>Updated by</dt>
								<dd>{{ return.authorship.updatedBy }} <span>at</span> {{ return.authorship.updatedAt|date }}</dd>
						{% endif %}
					</dl>
				</div>
			</div>
		</section>
	</div>

{% endblock returns %}